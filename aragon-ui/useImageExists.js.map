{"version":3,"file":"useImageExists.js","sources":["../src/lib/cached-map.js","../src/hooks/useImageExists.js"],"sourcesContent":["const A_DAY = 1000 * 60 * 60 * 24\n\nfunction cachedMap({ expireAfter = A_DAY, size = 100 } = {}) {\n  const cache = new Map()\n\n  // Delete the first (oldest) entry if we are above `size`. `cache.size`\n  // should never be greater than `size + 1`, so no need for a loop here.\n  function trim() {\n    if (cache.size > size) {\n      cache.delete(cache.keys().next().value)\n    }\n  }\n\n  // We are using delete() then set() to reset the position everytime the\n  // access is refreshed. That way, the oldest entry is always at the first\n  // position and we donâ€™t need to iterate over the entire cache to find it.\n  function update(key, value, lastAccess) {\n    cache.delete(key)\n    cache.set(key, { value, lastAccess })\n    trim()\n  }\n\n  function get(key) {\n    const now = new Date()\n\n    const cachedEntry = cache.get(key)\n\n    if (!cachedEntry) {\n      return null\n    }\n\n    // Expired: delete the entry\n    if (now - cachedEntry.lastAccess > expireAfter) {\n      cache.delete(key)\n      return null\n    }\n\n    update(key, cachedEntry.value, now)\n\n    return cachedEntry.value\n  }\n\n  function set(key, value) {\n    update(key, value, new Date())\n  }\n\n  return {\n    clear: () => cache.clear(),\n    delete: key => cache.delete(key),\n    get,\n    set,\n  }\n}\n\nexport default cachedMap\n","import { useEffect, useMemo, useState } from 'react'\nimport cachedMap from '../lib/cached-map'\n\nconst srcCache = cachedMap()\n\n// Check if a remote image exists and can be loaded within a specific amount of time.\nexport function useImageExists(src, timeUntilFallback = 50) {\n  const [exists, setExists] = useState(false)\n  const [loading, setLoading] = useState(true)\n  const [displayFallback, setDisplayFallback] = useState(false)\n\n  useEffect(() => {\n    let image = new Image()\n    const fallbackTimer = setTimeout(\n      () => setDisplayFallback(true),\n      timeUntilFallback\n    )\n\n    const init = () => {\n      if (!src) {\n        setExists(false)\n        setLoading(false)\n        return\n      }\n\n      if (srcCache.get(src)) {\n        success()\n        return\n      }\n\n      setExists(false)\n      setLoading(true)\n\n      // TODO: ensure only one image is loading at a time for a given src.\n      image.addEventListener('load', success)\n      image.src = src\n    }\n\n    const success = () => {\n      setLoading(false)\n      setExists(true)\n      srcCache.set(src, true)\n      done()\n    }\n\n    const done = () => {\n      clearTimeout(fallbackTimer)\n      if (image) {\n        image.removeEventListener('load', success)\n        image = null\n      }\n    }\n\n    init()\n\n    return done\n  }, [src, timeUntilFallback])\n\n  return useMemo(() => {\n    return { src, displayFallback, exists, loading }\n  }, [src, displayFallback, exists, loading])\n}\n\n// render prop\nexport const ImageExists = ({ timeUntilFallback, src, children }) =>\n  children(useImageExists(src, timeUntilFallback))\n"],"names":["A_DAY","cachedMap","expireAfter","size","cache","Map","trim","delete","keys","next","value","update","key","lastAccess","set","get","now","Date","cachedEntry","clear","srcCache","useImageExists","src","timeUntilFallback","exists","setExists","useState","loading","setLoading","displayFallback","setDisplayFallback","useEffect","image","Image","fallbackTimer","setTimeout","init","success","addEventListener","done","clearTimeout","removeEventListener","useMemo","ImageExists","children"],"mappings":"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"}